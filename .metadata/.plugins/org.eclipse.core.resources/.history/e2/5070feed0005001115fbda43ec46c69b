package com.bankapp.entities;

import java.math.BigDecimal;
import java.time.LocalDateTime;

import com.bankapp.enums.ApprovalStatus;
import com.bankapp.enums.TransactionType;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToOne;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Entity
public class Transaction {
	@Id
	@GeneratedValue(strategy = GenerationType.UUID)
	private String id;

	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "account_id", nullable = false)
	private Account account;

	@Enumerated(EnumType.STRING)
	@Column(nullable = false)
	private TransactionType transactionType;

	@Enumerated(EnumType.STRING)
	@Column(nullable = false)
	private ApprovalStatus approvalStatus;

	@Column(nullable = false)
	private BigDecimal amount;

	@Column(nullable = false)
	private LocalDateTime createdAt;

	@Column(nullable = false)
	private String performedByUserId;

	private String approvedByUserId;

	public static Transaction createDeposit(Account account, BigDecimal amount, String performedByUserId) {
		return new Transaction(null, account, TransactionType.DEPOSIT, ApprovalStatus.APPROVED, amount,
				LocalDateTime.now(), performedByUserId, null);
	}

	public static Transaction createPendingWithdrawal(Account account, BigDecimal amount, String performedByUserId) {
		return new Transaction(null, account, TransactionType.WITHDRAWAL, ApprovalStatus.PENDING_APPROVAL, amount,
				LocalDateTime.now(), performedByUserId, null);
	}

	public void approve(String managerUserId) {
		if (this.approvalStatus != ApprovalStatus.PENDING_APPROVAL) {
			throw new IllegalStateException("Transaction is not pending for approval");
		}
		this.approvalStatus = ApprovalStatus.APPROVED;
		this.approvedByUserId = managerUserId;
	}
	
	public void reject(String managerUserId) {
        if (this.approvalStatus != ApprovalStatus.PENDING_APPROVAL) {
            throw new IllegalStateException("Transaction is not pending approval");
        }
        this.approvalStatus = ApprovalStatus.REJECTED;
        this.approvedByUserId = managerUserId;
    }
}
